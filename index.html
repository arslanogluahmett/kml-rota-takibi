<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş KML Rota Navigasyon Sistemi V8</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        #map { height: 60vh; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .info-box { background-color: #ffffff; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); margin-top: 1rem; }
        .leaflet-container { z-index: 1; }
        .map-control-button { transition: all 0.2s; }
        .user-marker div { border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        /* Başlangıç İşaretçisi Stili - DAHA KALIN VE BELİRGİN */
        .start-marker div { 
            background-color: #10b981; /* Emerald 500 */ 
            width: 25px; 
            height: 25px; 
            border-radius: 50%; 
            border: 4px solid white; 
            box-shadow: 0 0 10px rgba(0,0,0,0.7); 
        }
        /* Duraklama/Segment Sonu İşaretçisi Stili (Yeni Stil) */
        .stop-point-marker div { 
            background-color: #f97316; /* Orange 500 */
            color: white; 
            padding: 0.5rem; 
            font-size: 0.75rem; 
            font-weight: bold; 
            border-radius: 9999px; /* Full rounded */
            box-shadow: 0 0 5px rgba(0,0,0,0.5); 
            min-width: 40px;
            text-align: center;
        }
        /* Dönüş İşaretçisi Stili - DAHA KÜÇÜK VE TRANSPARAN */
        .turn-marker div { 
            background-color: rgba(245, 158, 11, 0.7); /* Amber 500 - daha transparan */
            color: white; 
            padding: 0.15rem 0.3rem; /* Daha az padding */
            font-size: 0.6rem; /* Daha küçük font */
            font-weight: bold; 
            border-radius: 12px; /* Daha az yuvarlak */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); /* Daha hafif gölge */
            min-width: 28px; /* Daha küçük genişlik */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.6); /* Daha transparan kenar */
            line-height: 1.2;
        }
        .route-segment-line { 
            border-color: #1f2937; /* Gray 800 */
        }
    </style>
    <!-- Leaflet (OpenStreetMap için) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">KML Rota Takip Sistemi (Segmentli)</h1>
        
        <!-- KML Yükleme Alanı -->
        <div id="file-input-container" class="info-box bg-gray-50 border-gray-200 border p-3 mb-4">
            <label for="kml-file" class="block text-sm font-medium text-gray-700 mb-2">KML Dosyası Yükle (Google Earth Rota):</label>
            <input type="file" id="kml-file" accept=".kml" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100 cursor-pointer
            "/>
            <p id="kml-status" class="text-xs mt-2 text-red-500">Henüz KML dosyası yüklenmedi.</p>
        </div>

        <!-- Harita Alanı -->
        <div id="map"></div>

        <!-- Kontrol ve Bilgi Alanı -->
        <div class="info-box flex flex-col md:flex-row justify-between items-center">
            <div class="mb-4 md:mb-0 md:w-2/3">
                <p class="text-lg font-semibold text-gray-700">Durum: <span id="status-text" class="font-normal text-blue-600">Başlatılmadı</span></p>
                <p class="text-sm text-gray-600 mt-1">Yönlendirme: <span id="guidance-text" class="font-medium text-gray-800">Lütfen KML dosyası yükleyin.</span></p>
                <p class="text-xs text-gray-500 mt-1">Kullanıcı ID: <span id="user-id-display">Yükleniyor...</span> | Mevcut Segment: <span id="current-segment-display">0</span></p>
            </div>
            
            <button id="start-button" class="map-control-button w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50" disabled>
                Rotayı Başlat
            </button>
        </div>

        <div id="message-container" class="mt-4 p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg">
            <p><strong>UYARI:</strong> Bu uygulama gerçek bir navigasyon uygulaması değil simülasyondur. Rota takibi sadece tarayıcınızın GPS verileri üzerinden çalışır.</p>
        </div>
    </div>

    <script>
        // Global değişkenler ve Eşikler
        let map;
        let ALL_ROUTE_COORDS = []; // KML'den gelen tüm ham koordinatlar
        let ROUTE_SEGMENTS = []; // Segmentlere ayrılmış rota: [[segment1 points], [segment2 points], ...]
        let kmlSegmentPolylines = []; // Segment çizgileri (siyah)
        let currentRoutePolyline; // Kullanıcının ilerlediği çizgi (mavi)
        
        let isTracking = false; 
        let userMarker;
        let watchId = null; 
        
        let currentSegmentIndex = 0; // Hangi segmentin takip edildiği
        let nearestPointIndexInSegment = 0; // Segment içindeki en yakın nokta indeksi
        
        let turnMarkers = []; 
        let isDrawingTrack = false; 
        let startMarker = null; 
        let stopPointMarkers = []; // Duraklama/Segment Sonu İşaretçileri (turuncu)

        // *** İYİLEŞTİRME: Dönüş eşiği 5'ten 15'e yükseltildi ***
        const ANGLE_THRESHOLD = 10; // Daha belirgin dönüşleri yakalamak için eşik (Derece)
		const SHARP_TURN_THRESHOLD = 60;

        // *** İYİLEŞTİRME: Segment ayırma eşiği 100m'den 200m'ye çıkarıldı ***
        const SEGMENT_BREAK_DISTANCE_METERS = 200; // Segment ayırma eşiği (200 metreden büyük atlamalar)
        const RESUME_RADIUS_METERS = 50; // Başlangıç/Devam için yakınlık eşiği
        const OFF_ROUTE_DISTANCE_METERS = 25; // Rotadan sapma için eşik
        const START_PROMPT_INTERVAL_MS = 30000; 
        const NAVIGATION_PROMPT_INTERVAL_MS = 5000; 
        const AVERAGE_SPEED_KMH = 5; 
        
        let lastStartPromptTime = 0; 
        let lastNavigationPromptTime = 0; 
        let lastDistanceAnnouncementTime = 0; // Son mesafe bildirimi zamanı

        /**
         * İki koordinat arasındaki mesafeyi hesaplar (metre cinsinden - Harversine)
         */
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        /**
         * Rotanın kalan mesafesini hesaplar (kilometre cinsinden).
         * @param {number} segmentIndex Başlangıç segmenti.
         * @param {number} startIndexSegment Segment içindeki başlangıç noktası indeksi.
         * @returns {number} Kalan mesafe (km).
         */
        function calculateRemainingDistance(segmentIndex, startIndexSegment) {
            let totalDistanceMeters = 0;
            
            // Mevcut segmentin kalan mesafesini topla
            const currentSegment = ROUTE_SEGMENTS[segmentIndex];
            for (let i = startIndexSegment; i < currentSegment.length - 1; i++) {
                const p1 = currentSegment[i];
                const p2 = currentSegment[i + 1];
                totalDistanceMeters += haversineDistance(p1[0], p1[1], p2[0], p2[1]);
            }
            
            // Sonraki tüm segmentlerin tam mesafesini topla
            for (let s = segmentIndex + 1; s < ROUTE_SEGMENTS.length; s++) {
                const segment = ROUTE_SEGMENTS[s];
                for (let i = 0; i < segment.length - 1; i++) {
                    const p1 = segment[i];
                    const p2 = segment[i + 1];
                    totalDistanceMeters += haversineDistance(p1[0], p1[1], p2[0], p2[1]);
                }
            }
            
            return totalDistanceMeters / 1000; // Kilometreye çevir
        }

        /**
         * Kilometre cinsinden mesafeyi alıp Tahmini Süre hesaplar.
         * @param {number} distanceKm Kalan mesafe (km).
         * @returns {string} Tahmini süre metni (ör: "25 dakika").
         */
        function calculateEstimatedTime(distanceKm) {
            if (distanceKm <= 0.05) return "çok az kaldı"; 
            
            const timeHours = distanceKm / AVERAGE_SPEED_KMH;
            const timeMinutes = Math.round(timeHours * 60);
            
            if (timeMinutes < 1) return "1 dakikadan az";
            if (timeMinutes < 60) return `${timeMinutes} dakika`;
            
            const hours = Math.floor(timeMinutes / 60);
            const minutes = timeMinutes % 60;
            
            if (minutes === 0) return `${hours} saat`;
            return `${hours} saat ${minutes} dakika`;
        }

        /**
         * Kullanıcının rotadaki en yakın çizgi parçasına olan dikey mesafesini hesaplar.
         */
        function getClosestDistanceToCurrentSegment(lat, lng) {
            const currentSegment = ROUTE_SEGMENTS[currentSegmentIndex];
            if (!currentSegment) return { distance: Infinity, closestIndex: -1 };

            let minDistance = Infinity;
            let closestIndex = -1;
            
            // Yalnızca mevcut segmentin ilerleyen kısmını kontrol et
            const checkStart = Math.max(0, nearestPointIndexInSegment - 5);
            const checkEnd = Math.min(currentSegment.length, nearestPointIndexInSegment + 20);
            
            for (let i = checkStart; i < currentSegment.length; i++) {
                const p = currentSegment[i];
                const distance = haversineDistance(lat, lng, p[0], p[1]);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = i;
                }
            }
            
            return { distance: minDistance, closestIndex: closestIndex };
        }

        /**
         * İki nokta arasındaki kerteriz (açı) hesaplar (0-360 derece)
         */
        function calculateBearing(latA, lonA, latB, lonB) {
            const lat1 = latA * Math.PI / 180;
            const lat2 = latB * Math.PI / 180;
            const dLon = (lonB - lonA) * Math.PI / 180;
            
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                      Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            
            let brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }

        /**
         * Üç ardışık rota segmenti arasındaki dönüş açısını hesaplar.
         */
        function calculateTurnAngle(p1, p2, p3) {
            const bearing1 = calculateBearing(p1[0], p1[1], p2[0], p2[1]);
            const bearing2 = calculateBearing(p2[0], p2[1], p3[0], p3[1]);
            
            let angle = bearing2 - bearing1;
            if (angle > 180) angle -= 360;
            if (angle < -180) angle += 360;
            
            return angle;
        }
        
        // Metin okuma (TTS) fonksiyonu
        function speak(text) {
            if ('speechSynthesis' in window) {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR'; 
                speechSynthesis.speak(utterance);
            } else {
                console.warn("Tarayıcınız sesli okumayı desteklemiyor.");
            }
        }
        
        /**
         * KML dosyasını okur ve LineString verilerini rotaya dönüştürür.
         */
        function handleKmlUpload(event) {
            const file = event.target.files[0];
            const kmlStatus = document.getElementById('kml-status');
            
            // Tüm küresel rota ve marker değişkenlerini sıfırla
            ALL_ROUTE_COORDS = [];
            ROUTE_SEGMENTS = []; 
            kmlSegmentPolylines.forEach(p => map.removeLayer(p));
            kmlSegmentPolylines = [];
            turnMarkers.forEach(m => map.removeLayer(m.marker));
            turnMarkers = []; 
            stopPointMarkers.forEach(m => map.removeLayer(m.marker));
            stopPointMarkers = [];

            if (currentRoutePolyline) { currentRoutePolyline.setLatLngs([]); }
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
            
            // Tüm takip durumlarını sıfırla
            stopTracking(false);
            currentSegmentIndex = 0;
            nearestPointIndexInSegment = 0;
            isDrawingTrack = false;
            document.getElementById('start-button').disabled = true;

            if (!file) {
                kmlStatus.textContent = "KML Dosyası Yüklenemedi.";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const kmlText = e.target.result;
                
                try {
                    const parser = new DOMParser();
                    const kmlDom = parser.parseFromString(kmlText, 'text/xml');
                    
                    // KML koordinatlarını ayrıştır
                    kmlDom.querySelectorAll('coordinates').forEach(coordsEl => {
                        const coordsText = coordsEl.textContent.trim();
                        if (coordsText) {
                            const coordsArray = coordsText.split(/\s+/).filter(c => c.length > 0);
                            coordsArray.forEach(coordStr => {
                                const parts = coordStr.split(',');
                                if (parts.length >= 2) {
                                    const lat = parseFloat(parts[1]);
                                    const lng = parseFloat(parts[0]);
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        ALL_ROUTE_COORDS.push([lat, lng]);
                                    }
                                }
                            });
                        }
                    });

                    // Koordinatları basitleştirme (ardışık yakın noktaları atlama)
                    // Not: Bu kısım, dönüş açısı hesaplamasının daha hassas olması için 2m'den az mesafedeki noktaları atlar.
                    ALL_ROUTE_COORDS = ALL_ROUTE_COORDS.filter((coord, index, self) => {
                        if (index === 0) return true;
                        return haversineDistance(coord[0], coord[1], self[index - 1][0], self[index - 1][1]) > 2;
                    });
                    
                    if (ALL_ROUTE_COORDS.length < 2) {
                        kmlStatus.textContent = "HATA: KML dosyası geçerli bir rota (en az 2 nokta) içermiyor.";
                        document.getElementById('start-button').disabled = true;
                        return;
                    }
                    
                    // SEGMENTASYON: 200 metreden büyük atlamalarda rotayı kes
                    let currentSegment = [];
                    for (let i = 0; i < ALL_ROUTE_COORDS.length; i++) {
                        const currentPoint = ALL_ROUTE_COORDS[i];
                        
                        if (i > 0) {
                            const previousPoint = ALL_ROUTE_COORDS[i - 1];
                            const distance = haversineDistance(previousPoint[0], previousPoint[1], currentPoint[0], currentPoint[1]);
                            
                            // Mesafe 200 metreden büyükse, segmenti bitir ve yeni bir segment başlat
                            if (distance > SEGMENT_BREAK_DISTANCE_METERS) {
                                if (currentSegment.length > 1) {
                                    // Önceki segmentin son noktasını eklemeden segmenti bitir
                                    ROUTE_SEGMENTS.push(currentSegment); 
                                    
                                    // Duraklama İşaretçisi Ekle (Önceki segmentin son noktasına)
                                    const stopLatlng = currentSegment[currentSegment.length - 1];
                                    const marker = L.marker(stopLatlng, {
                                        icon: L.divIcon({
                                            className: 'stop-point-marker',
                                            html: '<div>BİTİŞ</div>',
                                            iconSize: [40, 40],
                                        })
                                    }).addTo(map)
                                      .bindPopup(`<b>Segment Sonu (Gün Sonu)</b>`);
                                    stopPointMarkers.push({ marker, segmentIndex: ROUTE_SEGMENTS.length - 1, isSegmentStart: false });

                                    currentSegment = []; // Yeni segmenti başlat
                                }
                            }
                        }
                        currentSegment.push(currentPoint);
                    }
                    // Son segmenti ekle
                    if (currentSegment.length > 1) {
                         ROUTE_SEGMENTS.push(currentSegment);
                    }
                    
                    if (ROUTE_SEGMENTS.length === 0) {
                         kmlStatus.textContent = "HATA: KML rotası geçerli segmentler içermiyor.";
                         document.getElementById('start-button').disabled = true;
                         return;
                    }

                    // Rota Segmentlerini Çizme ve Başlangıç İşaretçileri Ekleme
                    let allPoints = []; // Harita Bounds için
                    ROUTE_SEGMENTS.forEach((segment, index) => {
                        const polyline = L.polyline(segment, {
                            color: '#1f2937', 
                            weight: 5,
                            opacity: 0.7,
                            className: 'route-segment-line'
                        }).addTo(map);
                        kmlSegmentPolylines.push(polyline);
                        allPoints = allPoints.concat(segment);
                        
                        // Başlangıç İşaretçisi (Sadece ilk segment için yeşil, diğerleri turuncu "BAŞLANGIÇ")
                        const startLatlng = segment[0];
                        
                        if (index === 0) {
                            // *** İYİLEŞTİRME: Başlangıç işaretçisi daha belirgin hale getirildi ***
                            startMarker = L.marker(startLatlng, { 
                                icon: L.divIcon({ 
                                    className: 'start-marker', 
                                    html: '<div class="start-marker-div"></div>', 
                                    iconSize: [25, 25] 
                                })
                            }).addTo(map)
                                .bindPopup("<b>Rota Başlangıç Noktası (Gün 1)</b>");
                        } else {
                            // Yeni segment başlangıç noktalarına turuncu "BAŞLANGIÇ" markerı
                             const marker = L.marker(startLatlng, {
                                icon: L.divIcon({
                                    className: 'stop-point-marker',
                                    html: '<div>BAŞLA</div>',
                                    iconSize: [40, 40],
                                })
                            }).addTo(map)
                              .bindPopup(`<b>Segment Başlangıcı (Gün ${index + 1})</b>`);
                             stopPointMarkers.push({ marker, segmentIndex: index, isSegmentStart: true });
                        }
                    });

                    // Dönüş Noktalarını İşaretle (Her segment için ayrı ayrı)
                    findAndMarkTurns(); 

                    map.fitBounds(L.latLngBounds(allPoints.map(p => L.latLng(p[0], p[1])))); 
                    
                    const totalDistanceKm = calculateRemainingDistance(0, 0);
                    kmlStatus.textContent = `KML Başarıyla Yüklendi! Toplam Segment: ${ROUTE_SEGMENTS.length}. Toplam Rota Uzunluğu: ${totalDistanceKm.toFixed(2)} km.`;
                    kmlStatus.classList.remove('text-red-500');
                    kmlStatus.classList.add('text-green-500');
                    document.getElementById('guidance-text').textContent = 'Rotaya başlamak için yeşil noktaya yaklaşın.';
                    document.getElementById('start-button').textContent = 'Rotayı Başlat';
                    document.getElementById('current-segment-display').textContent = '1 / ' + ROUTE_SEGMENTS.length;
                    speak("K M L dosyası başarıyla yüklendi. Segmentli rota takip edilecek.");
                    
                } catch (error) {
                    console.error("KML ayrıştırma hatası:", error);
                    kmlStatus.textContent = "HATA: KML dosya formatı okunamadı. (Ayrıştırma Hatası)";
                    document.getElementById('start-button').disabled = true;
                }
            };
            
            reader.readAsText(file); 
        }

        /**
         * Rota noktalarını tarayarak belirgin dönüş noktalarını bulur ve işaretler.
         * İYİLEŞTİRME: Dönüş tespitini iyileştirdik
         */
        function findAndMarkTurns() {
             turnMarkers.forEach(m => map.removeLayer(m.marker));
             turnMarkers = [];
             
             // *** İYİLEŞTİRME: Minimum mesafe artırıldı ve dönüş açısı eşiği yükseltildi ***
             const MIN_DISTANCE_METERS = 8; // Daha az dönüş işaretleyicisi için mesafe artırıldı

             ROUTE_SEGMENTS.forEach(segment => {
                 if (segment.length < 3) return;
                 
				for (let i = 1; i < segment.length - 2; i++) {
					const p1 = segment[i - 1];
					const p2 = segment[i];
					const p3 = segment[i + 1];
					const p4 = segment[i + 2]; // ek nokta, daha geniş bakış

					const angle1 = calculateTurnAngle(p1, p2, p3);
					const angle2 = calculateTurnAngle(p2, p3, p4);

					const combinedAngle = (angle1 + angle2) / 2;

					if (Math.abs(combinedAngle) > ANGLE_THRESHOLD || Math.abs(angle1) > SHARP_TURN_THRESHOLD) {
						const turnDirection = combinedAngle < 0 ? "Sol" : "Sağ";
						const turnDegree = Math.round(Math.abs(combinedAngle));

						const lastTurn = turnMarkers.length > 0 ? turnMarkers[turnMarkers.length - 1] : null;
						if (lastTurn && haversineDistance(lastTurn.latlng[0], lastTurn.latlng[1], p2[0], p2[1]) < MIN_DISTANCE_METERS) continue;

						const marker = L.marker(p2, {
							icon: L.divIcon({
								className: 'turn-marker',
								html: `<div>${turnDirection.toUpperCase()}</div>`,
								iconSize: [30, 30],
							})
						}).addTo(map)
						  .bindPopup(`<b>${turnDirection}a Keskin Dönüş</b> (${turnDegree}°)`);

						turnMarkers.push({
							marker,
							index: i,
							direction: turnDirection,
							degree: turnDegree,
							latlng: p2
						});
					}
				}
             });
        }

        // Haritayı başlatma
        function setupMap() {
            if (map) map.remove();
            map = L.map('map').setView([41.015137, 28.979530], 13); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            currentRoutePolyline = L.polyline([], {
                color: 'blue',
                weight: 7,
                opacity: 0.9
            }).addTo(map);

            document.getElementById('start-button').disabled = true;
        }

        // Navigasyon ve Takip Mantığı
        function guidanceLogic(lat, lng, heading) {
            const userLatLng = [lat, lng];
            const currentTime = Date.now();
            const currentSegment = ROUTE_SEGMENTS[currentSegmentIndex];

            // Marker Güncelleme ve Harita Ortalaması
            if (userMarker) {
                userMarker.setLatLng(userLatLng);
            } else {
                userMarker = L.marker(userLatLng, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background-color:blue; width:15px; height:15px; border-radius:50%; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                        iconSize: [15, 15],
                    })
                }).addTo(map);
            }
            
            map.panTo(userLatLng);
            

            if (ROUTE_SEGMENTS.length === 0) {
                 document.getElementById('guidance-text').textContent = 'Lütfen KML dosyası yükleyin. Konumunuz takip ediliyor.';
                 return;
            }
            
            // Rota Takibi Aktif
            if (isTracking) {
                document.getElementById('status-text').textContent = 'Rota Takibi Aktif';
                document.getElementById('start-button').textContent = 'Takip Aktif (Durdur)';
                document.getElementById('start-button').classList.remove('bg-green-600', 'bg-blue-600');
                document.getElementById('start-button').classList.add('bg-red-600');
                document.getElementById('start-button').disabled = false;


                const { distance: minDistance, closestIndex } = getClosestDistanceToCurrentSegment(lat, lng);
                
                // Rotadaki ilerleme durumunu güncelle
                if (closestIndex !== -1 && closestIndex > nearestPointIndexInSegment) {
                     nearestPointIndexInSegment = closestIndex; 
                } 

                const remainingDistanceKm = calculateRemainingDistance(currentSegmentIndex, nearestPointIndexInSegment);
                const estimatedTimeText = calculateEstimatedTime(remainingDistanceKm);
                
                let guidanceMessage = `Rotayı takip ediyorsunuz. Tamamlanmasına yaklaşık ${remainingDistanceKm.toFixed(2)} km kaldı. (Tahmini süre: ${estimatedTimeText})`;
                
                // Rotadan Uzaklaşma Kontrolü (25m)
                if (minDistance > OFF_ROUTE_DISTANCE_METERS) {
                    guidanceMessage = `Rotadan ${Math.round(minDistance)} metre uzaktasınız! Lütfen siyah rotaya geri dönün.`;
                    if (currentTime - lastNavigationPromptTime > NAVIGATION_PROMPT_INTERVAL_MS && !speechSynthesis.speaking) {
                       speak(`Dikkat, rotadan ${Math.round(minDistance)} metre uzaktasınız. Rotaya geri dönün.`);
                       lastNavigationPromptTime = currentTime;
                    }
                    document.getElementById('guidance-text').textContent = guidanceMessage;
                    document.getElementById('start-button').disabled = true; // Rotadan saparsa durduramaz
                    return;
                }
                
                // Mavi rota çizimine devam et
                if(isDrawingTrack) {
                    currentRoutePolyline.addLatLng(userMarker.getLatLng());
                }

                // SEGMENT SONU KONTROLÜ
                const isEndOfSegment = nearestPointIndexInSegment >= currentSegment.length - 2; 
                if (isEndOfSegment) {
                    // Segment sonuna yaklaşıldı
                    const nextTargetIndex = currentSegment.length - 1;
                    const segmentEndLatLng = currentSegment[nextTargetIndex];
                    const distToSegmentEnd = haversineDistance(lat, lng, segmentEndLatLng[0], segmentEndLatLng[1]);
                    
                    if (distToSegmentEnd < RESUME_RADIUS_METERS) {
                        // Segmentin sonuna ulaşıldı
                        isTracking = false; 
                        isDrawingTrack = false;
                        
                        // Son segment mi?
                        if (currentSegmentIndex === ROUTE_SEGMENTS.length - 1) {
                            const finishText = 'Rotayı başarıyla tamamladınız! Harika sürüş.';
                            document.getElementById('guidance-text').textContent = finishText;
                            document.getElementById('status-text').textContent = 'TAMAMLANDI';
                            document.getElementById('start-button').textContent = 'Rotayı Başlat';
                            document.getElementById('start-button').classList.remove('bg-red-600');
                            document.getElementById('start-button').classList.add('bg-blue-600');
                            document.getElementById('start-button').disabled = true;
                            speak(finishText);
                            return;
                        } else {
                            // Segment bitti, bir sonraki segmente geçiş bekleniyor.
                            currentSegmentIndex++; // Bir sonraki segmentin başlangıcına hazırlan
                            nearestPointIndexInSegment = 0;
                            currentRoutePolyline.setLatLngs([]); // Mavi çizgiyi temizle
                            
                            const nextSegmentStartPoint = ROUTE_SEGMENTS[currentSegmentIndex][0];

                            document.getElementById('status-text').textContent = 'SEGMENT BİTİŞİ';
                            document.getElementById('current-segment-display').textContent = (currentSegmentIndex + 1) + ' / ' + ROUTE_SEGMENTS.length;
                            guidanceMessage = `Gün ${currentSegmentIndex} tamamlandı. Devam etmek için turuncu BAŞLA noktasına yaklaşın.`;
                            document.getElementById('guidance-text').textContent = guidanceMessage;
                            
                            // Tekrar bekleme (devam etme) moduna geç
                            map.panTo(nextSegmentStartPoint);
                            
                            speak(`Segment ${currentSegmentIndex} tamamlandı. Bir sonraki güne başlamak için BAŞLA noktasına gidiniz.`);
                            // Devam Et butonu, bekleme mantığında aktif edilecek.
                        }
                    }
                }
                
                // Dönüş Uyarıları (Aktif Takip Sırasında)
                let nextTurn = null;
                let nextTurnDistance = Infinity;

                for (const turn of turnMarkers) {
                    // Yalnızca mevcut segmentin dönüşlerini ve ilerideki dönüşleri kontrol et
                    if (turn.index > nearestPointIndexInSegment + 5 && 
                        (turn.latlng[0] >= currentSegment[0][0] && turn.latlng[0] <= currentSegment[currentSegment.length-1][0] ||
                         turn.latlng[0] <= currentSegment[0][0] && turn.latlng[0] >= currentSegment[currentSegment.length-1][0])) 
                    {
                        const dist = haversineDistance(lat, lng, turn.latlng[0], turn.latlng[1]);
                        if (dist < nextTurnDistance) {
                            nextTurnDistance = dist;
                            nextTurn = turn;
                        }
                    }
                }
                
                if (nextTurn) {
                    let warningText = '';
                    const direction = nextTurn.direction;
                    
                    if (nextTurnDistance < 50) {
                        warningText = `Hemen ${direction}a dönün`;
                    } else if (nextTurnDistance < 100) {
                        warningText = `Yaklaşık 100 metre sonra ${direction}a dönün`;
                    } else if (nextTurnDistance < 200) {
                        warningText = `Yaklaşık 200 metre sonra ${direction}a dönün`;
                    }
                    
                    if (warningText && currentTime - lastNavigationPromptTime > NAVIGATION_PROMPT_INTERVAL_MS && !speechSynthesis.speaking) {
                        guidanceMessage = warningText;
                        speak(warningText);
                        lastNavigationPromptTime = currentTime;
                    }
                }
                
                document.getElementById('guidance-text').textContent = guidanceMessage;
                
            } else {
                // Takip Aktif Değil (Başlangıç veya Devam Etme Bekleniyor)
                document.getElementById('status-text').textContent = 'Başlatılmadı';
                document.getElementById('start-button').textContent = 'Rotayı Başlat';
                document.getElementById('start-button').classList.remove('bg-red-600');
                document.getElementById('start-button').classList.add('bg-blue-600');
                document.getElementById('start-button').disabled = false;

                // Başlangıç noktasına uzaklık kontrolü
                let targetPoint;
                if (currentSegmentIndex === 0) {
                    targetPoint = ROUTE_SEGMENTS[0][0];
                } else {
                    targetPoint = ROUTE_SEGMENTS[currentSegmentIndex][0];
                }
                
                const distanceToStart = haversineDistance(lat, lng, targetPoint[0], targetPoint[1]);
                
                // *** İYİLEŞTİRME: Başlangıç noktasına olan uzaklık sesli bildirimi ***
                if (currentTime - lastDistanceAnnouncementTime > 15000 && distanceToStart > 50 && !speechSynthesis.speaking) {
                    const roundedDistance = Math.round(distanceToStart / 10) * 10; // 10m'ye yuvarla
                    speak(`Başlangıç noktasına ${roundedDistance} metre uzaktasınız`);
                    lastDistanceAnnouncementTime = currentTime;
                }
                
                if (distanceToStart < RESUME_RADIUS_METERS) {
                    document.getElementById('guidance-text').textContent = `Rotayı başlatmak için butona tıklayın.`;
                    document.getElementById('start-button').disabled = false;
                    
                    if (currentTime - lastStartPromptTime > START_PROMPT_INTERVAL_MS && !speechSynthesis.speaking) {
                        speak("Rotayı başlatmak için ekrandaki butona tıklayın.");
                        lastStartPromptTime = currentTime;
                    }
                } else {
                    document.getElementById('guidance-text').textContent = `Rotayı başlatmak için ${currentSegmentIndex === 0 ? 'yeşil' : 'turuncu'} noktaya yaklaşın. (${Math.round(distanceToStart)} m uzaktasınız)`;
                    document.getElementById('start-button').disabled = true;
                }
            }
        }

        // GPS Takibi Başlatma
        function startTracking() {
            if (isTracking) {
                stopTracking(true);
                return;
            }
            
            if (ROUTE_SEGMENTS.length === 0) {
                alert("Lütfen önce KML dosyası yükleyin.");
                return;
            }
            
            isTracking = true;
            isDrawingTrack = true;
            document.getElementById('status-text').textContent = 'Rota Takibi Aktif';
            document.getElementById('start-button').textContent = 'Takip Aktif (Durdur)';
            document.getElementById('start-button').classList.remove('bg-blue-600');
            document.getElementById('start-button').classList.add('bg-red-600');
            
            // Mavi çizgiyi sıfırla
            currentRoutePolyline.setLatLngs([]);
            
            speak("Rota takibi başladı. Rotayı takip edin.");
        }
        
        // GPS Takibi Durdurma
        function stopTracking(manualStop) {
            isTracking = false;
            isDrawingTrack = false;
            document.getElementById('status-text').textContent = 'Durduruldu';
            document.getElementById('start-button').textContent = 'Rotayı Başlat';
            document.getElementById('start-button').classList.remove('bg-red-600');
            document.getElementById('start-button').classList.add('bg-blue-600');
            document.getElementById('guidance-text').textContent = manualStop ? 'Takip durduruldu.' : 'Takip sıfırlandı.';
            
            if (manualStop && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                speak("Takip durduruldu.");
            }
        }

        // GPS Konum Güncelleme
        function handlePositionUpdate(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const heading = position.coords.heading || 0;
            
            guidanceLogic(lat, lng, heading);
        }

        // GPS Hata Yönetimi
        function handlePositionError(error) {
            console.error("GPS Hatası:", error);
            let errorMessage = "Konum alınamadı: ";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += "Konum izni reddedildi.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += "Konum bilgisi alınamıyor.";
                    break;
                case error.TIMEOUT:
                    errorMessage += "Konum isteği zaman aşımına uğradı.";
                    break;
                default:
                    errorMessage += "Bilinmeyen hata.";
                    break;
            }
            
            document.getElementById('guidance-text').textContent = errorMessage;
            document.getElementById('status-text').textContent = 'GPS Hata';
        }

        // GPS Takibi Başlatma
        function startGpsTracking() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    handlePositionUpdate,
                    handlePositionError,
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 5000
                    }
                );
            } else {
                alert("Tarayıcınız GPS konum takibini desteklemiyor.");
            }
        }

        // Sayfa Yükleme Tamamlandığında
        document.addEventListener('DOMContentLoaded', function() {
            setupMap();
            
            // KML dosya yükleme olayını bağla
            document.getElementById('kml-file').addEventListener('change', handleKmlUpload);
            
            // Başlat/Durdur butonu
            document.getElementById('start-button').addEventListener('click', startTracking);
            
            // GPS izni ve takibi başlat
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    startGpsTracking();
                    document.getElementById('user-id-display').textContent = 'GPS Aktif';
                }, function(error) {
                    document.getElementById('user-id-display').textContent = 'GPS İzni Yok';
                    document.getElementById('guidance-text').textContent = 'GPS izni gerekli. Lütfen konum iznini etkinleştirin.';
                });
            } else {
                document.getElementById('user-id-display').textContent = 'GPS Yok';
                document.getElementById('guidance-text').textContent = 'Tarayıcınız GPS desteklemiyor.';
            }
        });
    </script>
</body>
</html>
