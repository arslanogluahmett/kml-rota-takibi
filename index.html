<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş KML Rota Navigasyon Sistemi V4</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Tailwind varsayılanı) -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        #map { height: 60vh; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .info-box { background-color: #ffffff; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); margin-top: 1rem; }
        .leaflet-container { z-index: 1; }
        .map-control-button { transition: all 0.2s; }
        .user-marker div { border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        /* Başlangıç İşaretçisi Stili */
        .start-marker div { background-color: #10b981; /* Emerald 500 */ width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        /* Dönüş İşaretçisi Stili */
        .turn-marker div { 
            background-color: #f59e0b; /* Amber 500 */
            color: white; 
            padding: 0.5rem; 
            font-size: 0.75rem; 
            font-weight: bold; 
            border-radius: 9999px; /* Full rounded */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); 
            min-width: 40px;
            text-align: center;
        }
        /* Durdurulmuş Konum İşaretçisi Stili */
        .stop-marker div {
            background-color: #ef4444; /* Red 500 */
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
    </style>
    <!-- Leaflet (OpenStreetMap için) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        const initializeFirebase = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

            if (Object.keys(firebaseConfig).length === 0) {
                 console.warn("Firebase konfigürasyonu bulunamadı. Sadece harita ve KML işlevi çalışacak.");
                 document.dispatchEvent(new Event('firebaseReady'));
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase ve Auth başarıyla başlatıldı. User ID:", window.userId);
                document.dispatchEvent(new Event('firebaseReady'));
            } catch (error) {
                console.error("Firebase başlatılırken veya oturum açılırken hata oluştu:", error);
            }
        };

        initializeFirebase();
    </script>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">KML Rota Takip Sistemi</h1>
        
        <!-- KML Yükleme Alanı -->
        <div id="file-input-container" class="info-box bg-gray-50 border-gray-200 border p-3 mb-4">
            <label for="kml-file" class="block text-sm font-medium text-gray-700 mb-2">KML Dosyası Yükle (Google Earth Rota):</label>
            <input type="file" id="kml-file" accept=".kml" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100 cursor-pointer
            "/>
            <p id="kml-status" class="text-xs mt-2 text-red-500">Henüz KML dosyası yüklenmedi.</p>
        </div>

        <!-- Harita Alanı -->
        <div id="map"></div>

        <!-- Kontrol ve Bilgi Alanı -->
        <div class="info-box flex flex-col md:flex-row justify-between items-center">
            <div class="mb-4 md:mb-0 md:w-2/3">
                <p class="text-lg font-semibold text-gray-700">Durum: <span id="status-text" class="font-normal text-blue-600">Başlatılmadı</span></p>
                <p class="text-sm text-gray-600 mt-1">Yönlendirme: <span id="guidance-text" class="font-medium text-gray-800">Lütfen KML dosyası yükleyin.</span></p>
                <p class="text-xs text-gray-500 mt-1">Kullanıcı ID: <span id="user-id-display">Yükleniyor...</span></p>
            </div>
            
            <button id="start-button" class="map-control-button w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50" disabled>
                Rotayı Başlat
            </button>
        </div>

        <div id="message-container" class="mt-4 p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg hidden">
            <p><strong>UYARI:</strong> Bu uygulama bir simülasyondu. Gerçek bir navigasyon uygulaması değildir. Rota takibi sadece tarayıcınızın GPS verileri üzerinden çalışır.</p>
        </div>
    </div>

    <script>
        // Global değişkenler ve Eşikler
        let map;
        let KML_ROUTE_COORDS = []; 
        let currentRoutePolyline; 
        let kmlRoutePolyline; 
        let isTracking = false; 
        let userMarker;
        let watchId = null; 
        let nearestPointIndex = 0; 
        let turnMarkers = []; 
        let isDrawingTrack = false; 
        let startMarker = null; // Başlangıç işaretçisi
        let lastValidStopLocation = null; // Durdurulan son geçerli konum [lat, lng]
        let stopLocationMarker = null; // Durdurulan konumu gösteren işaretçi

        const RESUME_RADIUS_METERS = 50; // Durdurulan yerden veya başlangıçtan devam etmek/başlatmak için yakınlık
        const OFF_ROUTE_DISTANCE_METERS = 25; // Rotadan sapma için eşik
        const START_PROMPT_INTERVAL_MS = 30000; 
        const NAVIGATION_PROMPT_INTERVAL_MS = 5000; 
        const AVERAGE_SPEED_KMH = 5; // Ortalama hız (Yürüyüş/Bisiklet için 5 km/s alındı)
        
        let lastStartPromptTime = 0; 
        let lastNavigationPromptTime = 0; 

        /**
         * İki koordinat arasındaki mesafeyi hesaplar (metre cinsinden - Harversine)
         */
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        /**
         * Rotanın kalan mesafesini hesaplar (kilometre cinsinden).
         * @param {number} startIndex Başlangıç noktası indeksi.
         * @returns {number} Kalan mesafe (km).
         */
        function calculateRemainingDistance(startIndex) {
            let totalDistanceMeters = 0;
            
            // Geçerli noktadan son noktaya kadar olan mesafeleri topla
            for (let i = startIndex; i < KML_ROUTE_COORDS.length - 1; i++) {
                const p1 = KML_ROUTE_COORDS[i];
                const p2 = KML_ROUTE_COORDS[i + 1];
                totalDistanceMeters += haversineDistance(p1[0], p1[1], p2[0], p2[1]);
            }
            
            return totalDistanceMeters / 1000; // Kilometreye çevir
        }

        /**
         * Kilometre cinsinden mesafeyi alıp Tahmini Süre hesaplar.
         * @param {number} distanceKm Kalan mesafe (km).
         * @returns {string} Tahmini süre metni (ör: "25 dakika").
         */
        function calculateEstimatedTime(distanceKm) {
            if (distanceKm <= 0.05) return "çok az kaldı"; 
            
            // Süre = Mesafe (km) / Hız (km/s)
            const timeHours = distanceKm / AVERAGE_SPEED_KMH;
            
            // Saati dakikaya çevir
            const timeMinutes = Math.round(timeHours * 60);
            
            if (timeMinutes < 1) return "1 dakikadan az";
            if (timeMinutes < 60) return `${timeMinutes} dakika`;
            
            const hours = Math.floor(timeMinutes / 60);
            const minutes = timeMinutes % 60;
            
            if (minutes === 0) return `${hours} saat`;
            return `${hours} saat ${minutes} dakika`;
        }

        /**
         * Kullanıcının rotadaki en yakın çizgi parçasına olan dikey mesafesini hesaplar.
         */
        function getClosestDistanceToRoute(lat, lng) {
            let minDistance = Infinity;
            let closestIndex = -1;
            
            // Segmentler arası en kısa mesafeyi bul
            for (let i = 0; i < KML_ROUTE_COORDS.length - 1; i++) {
                const p1 = KML_ROUTE_COORDS[i];
                const p2 = KML_ROUTE_COORDS[i + 1];

                // Segmentin ortasına olan yaklaşık uzaklık (hızlı kontrol)
                const midLat = (p1[0] + p2[0]) / 2;
                const midLng = (p1[1] + p2[1]) / 2;
                const distToMid = haversineDistance(lat, lng, midLat, midLng);

                const currentSegmentMinDist = distToMid;

                if (currentSegmentMinDist < minDistance) {
                    minDistance = currentSegmentMinDist;
                    closestIndex = i;
                }
            }
            
            // Rota takibi aktifse, ilerideki noktaları da kontrol et
            if (isTracking && closestIndex > -1) {
                 const checkStart = Math.max(0, nearestPointIndex - 5);
                 const checkEnd = Math.min(KML_ROUTE_COORDS.length, nearestPointIndex + 20);

                 for (let i = checkStart; i < checkEnd; i++) {
                    const p = KML_ROUTE_COORDS[i];
                    const distance = haversineDistance(lat, lng, p[0], p[1]);
                    if (distance < minDistance) {
                         minDistance = distance;
                         closestIndex = i;
                    }
                 }
            }
            
            return { distance: minDistance, closestIndex: closestIndex };
        }

        /**
         * İki nokta arasındaki kerteriz (açı) hesaplar (0-360 derece)
         */
        function calculateBearing(latA, lonA, latB, lonB) {
            const lat1 = latA * Math.PI / 180;
            const lat2 = latB * Math.PI / 180;
            const dLon = (lonB - lonA) * Math.PI / 180;
            
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                      Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            
            let brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }

        /**
         * Üç ardışık rota segmenti arasındaki dönüş açısını hesaplar.
         */
        function calculateTurnAngle(p1, p2, p3) {
            const bearing1 = calculateBearing(p1[0], p1[1], p2[0], p2[1]);
            const bearing2 = calculateBearing(p2[0], p2[1], p3[0], p3[1]);
            
            let angle = bearing2 - bearing1;
            if (angle > 180) angle -= 360;
            if (angle < -180) angle += 360;
            
            return angle;
        }
        
        // Metin okuma (TTS) fonksiyonu
        function speak(text) {
            if ('speechSynthesis' in window) {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR'; 
                speechSynthesis.speak(utterance);
            } else {
                console.warn("Tarayıcınız sesli okumayı desteklemiyor.");
            }
        }
        
        /**
         * KML dosyasını okur ve LineString verilerini rotaya dönüştürür.
         */
        function handleKmlUpload(event) {
            const file = event.target.files[0];
            const kmlStatus = document.getElementById('kml-status');
            KML_ROUTE_COORDS = []; 
            
            // Harita üzerindeki her şeyi temizle
            turnMarkers.forEach(m => map.removeLayer(m.marker));
            turnMarkers = []; 
            if (kmlRoutePolyline) { map.removeLayer(kmlRoutePolyline); kmlRoutePolyline = null; }
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
            if (stopLocationMarker) { map.removeLayer(stopLocationMarker); stopLocationMarker = null; }
            
            if (currentRoutePolyline) { currentRoutePolyline.setLatLngs([]); }
            
            // Tüm takip durumlarını sıfırla
            stopTracking(false);
            nearestPointIndex = 0;
            isDrawingTrack = false;
            lastValidStopLocation = null; 
            document.getElementById('start-button').disabled = true;

            if (!file) {
                kmlStatus.textContent = "KML Dosyası Yüklenemedi.";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const kmlText = e.target.result;
                
                try {
                    const parser = new DOMParser();
                    const kmlDom = parser.parseFromString(kmlText, 'text/xml');
                    
                    // KML koordinatlarını ayrıştır
                    kmlDom.querySelectorAll('coordinates').forEach(coordsEl => {
                        const coordsText = coordsEl.textContent.trim();
                        if (coordsText) {
                            const coordsArray = coordsText.split(/\s+/).filter(c => c.length > 0);
                            coordsArray.forEach(coordStr => {
                                const parts = coordStr.split(',');
                                if (parts.length >= 2) {
                                    const lat = parseFloat(parts[1]);
                                    const lng = parseFloat(parts[0]);
                                    if (!isNaN(lat) && !isNaN(lng)) {
                                        KML_ROUTE_COORDS.push([lat, lng]);
                                    }
                                }
                            });
                        }
                    });

                    // Koordinatları basitleştirme
                    KML_ROUTE_COORDS = KML_ROUTE_COORDS.filter((coord, index, self) => {
                        if (index === 0) return true;
                        // Önceki noktadan 2 metreden az uzaktaysa atla
                        return haversineDistance(coord[0], coord[1], self[index - 1][0], self[index - 1][1]) > 2;
                    });


                    if (KML_ROUTE_COORDS.length < 2) {
                        kmlStatus.textContent = "HATA: KML dosyası geçerli bir rota (en az 2 nokta) içermiyor.";
                        kmlStatus.classList.remove('text-green-500');
                        kmlStatus.classList.add('text-red-500');
                        document.getElementById('start-button').disabled = true;
                        return;
                    }
                    
                    findAndMarkTurns(); 

                    // Rota Çizimi
                    kmlRoutePolyline = L.polyline(KML_ROUTE_COORDS, {
                        color: 'black',
                        weight: 5,
                        opacity: 0.7
                    }).addTo(map);

                    // Başlangıç işaretçisi (Yeşil)
                    const startLatlng = KML_ROUTE_COORDS[0];
                    startMarker = L.marker(startLatlng, { 
                        icon: L.divIcon({ className: 'start-marker', html: '<div class="start-marker-div"></div>', iconSize: [20, 20] })
                    }).addTo(map)
                        .bindPopup("<b>Rota Başlangıç Noktası</b>");
                    
                    map.fitBounds(kmlRoutePolyline.getBounds()); 
                    
                    kmlStatus.textContent = `KML Başarıyla Yüklendi! Toplam Rota Uzunluğu: ${calculateRemainingDistance(0).toFixed(2)} km.`;
                    kmlStatus.classList.remove('text-red-500');
                    kmlStatus.classList.add('text-green-500');
                    document.getElementById('guidance-text').textContent = 'Rotaya başlamak için yeşil noktaya yaklaşın.';
                    document.getElementById('start-button').textContent = 'Rotayı Başlat';
                    speak("K M L dosyası başarıyla yüklendi. Rotanın başlangıç noktasına gidiniz.");
                    
                } catch (error) {
                    console.error("KML ayrıştırma hatası:", error);
                    kmlStatus.textContent = "HATA: KML dosya formatı okunamadı. (Ayrıştırma Hatası)";
                    kmlStatus.classList.remove('text-green-500');
                    kmlStatus.classList.add('text-red-500');
                    document.getElementById('start-button').disabled = true;
                }
            };
            
            reader.readAsText(file); 
        }

        /**
         * Rota noktalarını tarayarak belirgin dönüş noktalarını bulur ve işaretler.
         */
        function findAndMarkTurns() {
             turnMarkers.forEach(m => map.removeLayer(m.marker));
             turnMarkers = [];
             
             const ANGLE_THRESHOLD = 15; 
             const MIN_DISTANCE_METERS = 20; 
             
             if (KML_ROUTE_COORDS.length < 3) return;

             for (let i = 1; i < KML_ROUTE_COORDS.length - 1; i++) {
                const p1 = KML_ROUTE_COORDS[i - 1]; 
                const p2 = KML_ROUTE_COORDS[i];     
                const p3 = KML_ROUTE_COORDS[i + 1]; 

                const distToP2 = haversineDistance(p1[0], p1[1], p2[0], p2[1]);
                if (distToP2 < 5) continue; 
                
                const angle = calculateTurnAngle(p1, p2, p3);

                if (Math.abs(angle) > ANGLE_THRESHOLD) {
                    let turnDirection = angle < 0 ? "Sol" : "Sağ";
                    let turnDegree = Math.round(Math.abs(angle));
                    
                    // Önceki dönüş noktasına olan mesafeyi kontrol et
                    const lastTurn = turnMarkers.length > 0 ? turnMarkers[turnMarkers.length - 1] : null;
                    if (lastTurn && haversineDistance(lastTurn.latlng[0], lastTurn.latlng[1], p2[0], p2[1]) < MIN_DISTANCE_METERS) {
                        continue; 
                    }
                    
                    const marker = L.marker(p2, {
                        icon: L.divIcon({
                            className: 'turn-marker',
                            html: `<div class="bg-yellow-500 text-white p-1 text-xs font-bold rounded-full shadow-lg transform ${angle < 0 ? 'rotate-315' : 'rotate-45'}">
                                ${turnDirection.toUpperCase()}
                            </div>`,
                            iconSize: [40, 40],
                        })
                    }).addTo(map)
                      .bindPopup(`<b>${turnDirection}a Dönüş</b> (${turnDegree}° açı)`);
                    
                    turnMarkers.push({
                        marker: marker,
                        index: i,
                        direction: turnDirection,
                        degree: turnDegree,
                        latlng: p2
                    });
                }
            }
        }


        // Haritayı başlatma
        function setupMap() {
            if (map) map.remove();
            map = L.map('map').setView([41.015137, 28.979530], 13); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            currentRoutePolyline = L.polyline([], {
                color: 'blue',
                weight: 7,
                opacity: 0.9
            }).addTo(map);

            document.getElementById('start-button').disabled = true;
        }

        // Navigasyon ve Takip Mantığı
        function guidanceLogic(lat, lng, heading) {
            const userLatLng = [lat, lng];
            const currentTime = Date.now();
            
            // Marker Güncelleme ve Harita Ortalaması
            if (userMarker) {
                userMarker.setLatLng(userLatLng);
            } else {
                userMarker = L.marker(userLatLng, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background-color:blue; width:15px; height:15px; border-radius:50%; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                        iconSize: [15, 15],
                    })
                }).addTo(map);
            }
            
            // Haritayı sadece takip aktifken veya durma noktasına yönlendirirken ortala
            if (isTracking || (lastValidStopLocation && !isTracking)) {
                 map.panTo(userLatLng);
            }
            

            if (KML_ROUTE_COORDS.length === 0) {
                 document.getElementById('guidance-text').textContent = 'Lütfen KML dosyası yükleyin. Konumunuz takip ediliyor.';
                 return;
            }
            
            const { distance: minDistance, closestIndex } = getClosestDistanceToRoute(lat, lng);
            
            // --- Yeni Mesafe ve Süre Hesaplaması ---
            const remainingDistanceKm = calculateRemainingDistance(closestIndex);
            const estimatedTimeText = calculateEstimatedTime(remainingDistanceKm);


            // Rota sonu kontrolü
            if (isTracking && nearestPointIndex >= KML_ROUTE_COORDS.length - 1 && minDistance < RESUME_RADIUS_METERS) {
                const finishText = 'Rotayı başarıyla tamamladınız! Harika sürüş.';
                document.getElementById('guidance-text').textContent = finishText;
                document.getElementById('status-text').textContent = 'TAMAMLANDI';
                stopTracking(false); 
                speak(finishText);
                return;
            }

            // Durdurulmuş Konumdan Devam Etme VEYA Başlangıç Mantığı (isTracking == false)
            if (!isTracking) {
                document.getElementById('status-text').textContent = 'Bekleniyor';
                
                let guidanceText;
                let isButtonActive = false;
                let buttonText = 'Rotaya Yaklaşın';
                let targetLocation = null;

                if (lastValidStopLocation) {
                    // Durdurulan yerden devam etme modu
                    targetLocation = lastValidStopLocation;
                    const distToStop = haversineDistance(lat, lng, targetLocation.lat, targetLocation.lng);
                    
                    // Durdurma Konumu İşaretçisi Haritada Yoksa Ekle
                    if (!stopLocationMarker) {
                         stopLocationMarker = L.marker(targetLocation, { 
                            icon: L.divIcon({ className: 'stop-marker', html: '<div class="stop-marker-div"></div>', iconSize: [20, 20] })
                        }).addTo(map)
                        .bindPopup("<b>Durdurulan Konum (Devam Et)</b>");
                    }
                    
                    // Haritayı durdurulan konuma yönlendir
                    map.panTo(targetLocation); 

                    if (distToStop <= RESUME_RADIUS_METERS) {
                        isButtonActive = true;
                        buttonText = 'Devam Et';
                        guidanceText = `Durdurduğunuz yere ${Math.round(distToStop)}m uzaktasınız. Devam edebilirsiniz.`;
                    } else {
                        isButtonActive = false;
                        buttonText = 'Rotaya Yaklaşın';
                        guidanceText = `Durdurduğunuz yerden ${Math.round(distToStop)}m uzaktasınız. Devam etmek için kırmızı noktaya yaklaşın.`;
                        
                        // Yönlendirme uyarısı
                        if (currentTime - lastStartPromptTime > START_PROMPT_INTERVAL_MS && !speechSynthesis.speaking) {
                            speak(`Lütfen durdurduğunuz konuma gidiniz. Yaklaşık ${Math.round(distToStop)} metre uzaktasınız.`);
                            lastStartPromptTime = currentTime;
                        }
                    }

                } else {
                    // Başlangıç Modu (Durdurulan konum yok)
                    targetLocation = KML_ROUTE_COORDS[0]; // Başlangıç noktası
                    const distToStart = haversineDistance(lat, lng, targetLocation[0], targetLocation[1]);

                    // Haritayı başlangıç noktasına yönlendir
                    if (startMarker) map.panTo(startMarker.getLatLng());

                    if (distToStart <= RESUME_RADIUS_METERS) {
                        isButtonActive = true;
                        buttonText = 'Rotayı Başlat';
                        guidanceText = `Başlangıç noktasına ${Math.round(distToStart)}m uzaktasınız. Rotayı başlatabilirsiniz.`;
                    } else {
                        isButtonActive = false;
                        buttonText = 'Başlangıç Noktasına Yaklaşın';
                        guidanceText = `Başlangıç noktasına ${Math.round(distToStart)}m uzaktasınız. Başlatmak için yeşil noktaya yaklaşın.`;
                        
                        // Yönlendirme uyarısı
                        if (currentTime - lastStartPromptTime > START_PROMPT_INTERVAL_MS && !speechSynthesis.speaking) {
                            speak(`Rotayı başlatmak için yeşil noktaya gidiniz. Yaklaşık ${Math.round(distToStart)} metre uzaktasınız.`);
                            lastStartPromptTime = currentTime;
                        }
                    }
                }

                document.getElementById('start-button').textContent = buttonText;
                document.getElementById('start-button').disabled = !isButtonActive;
                document.getElementById('start-button').classList.remove('bg-blue-600', 'bg-red-600');
                document.getElementById('start-button').classList.add(isButtonActive ? 'bg-green-600' : 'bg-blue-600');
                document.getElementById('guidance-text').textContent = guidanceText;
                
                return;
            }
            
            // Rota Takibi Aktif
            document.getElementById('status-text').textContent = 'Rota Takibi Aktif';

            // Rotadaki ilerleme durumunu güncelle
            if (closestIndex > nearestPointIndex) {
                 // İlerideki noktalara ulaşılmışsa
                 nearestPointIndex = closestIndex; 
            }

            let guidanceMessage = `Rotayı takip ediyorsunuz. Tamamlanmasına yaklaşık ${remainingDistanceKm.toFixed(2)} km kaldı. (Tahmini süre: ${estimatedTimeText})`;
            
            // Rotadan Uzaklaşma Kontrolü (25m)
            if (minDistance > OFF_ROUTE_DISTANCE_METERS) {
                guidanceMessage = `Rotadan ${Math.round(minDistance)} metre uzaktasınız! Lütfen siyah rotaya geri dönün.`;
                if (currentTime - lastNavigationPromptTime > NAVIGATION_PROMPT_INTERVAL_MS && !speechSynthesis.speaking) {
                   speak(`Dikkat, rotadan ${Math.round(minDistance)} metre uzaktasınız. Rotaya geri dönün.`);
                   lastNavigationPromptTime = currentTime;
                }
                document.getElementById('guidance-text').textContent = guidanceMessage;
                return;
            } else {
                // Rotada kalınmışsa, durdurulan konumu sıfırla (eğer vardıysa)
                if (lastValidStopLocation) {
                    lastValidStopLocation = null;
                    if (stopLocationMarker) { map.removeLayer(stopLocationMarker); stopLocationMarker = null; }
                }
                
                // Mavi rota çizimine devam et
                if(isDrawingTrack) {
                    currentRoutePolyline.addLatLng(userMarker.getLatLng());
                }
                
                // Geri dönülmüşse ve tracking aktifse yeni guidance mesajını tekrar ayarla
                guidanceMessage = `Rotayı takip ediyorsunuz. Tamamlanmasına yaklaşık ${remainingDistanceKm.toFixed(2)} km kaldı. (Tahmini süre: ${estimatedTimeText})`;
            }


            // Gelişmiş Navigasyon Uyarıları
            let nextTurn = null;
            let nextTurnDistance = Infinity;

            // Kullanıcının ilerideki ilk kritik dönüş noktası bulma
            for (const turn of turnMarkers) {
                // Kullanıcının geçtiği noktaları atla
                if (turn.index > nearestPointIndex) { 
                    const dist = haversineDistance(lat, lng, turn.latlng[0], turn.latlng[1]);
                    if (dist < nextTurnDistance) {
                        nextTurnDistance = dist;
                        nextTurn = turn;
                    }
                }
            }
            
            if (nextTurn) {
                let warningText = '';
                const direction = nextTurn.direction === 'Sağ' ? 'sağa' : 'sola';
                
                if (currentTime - lastNavigationPromptTime > NAVIGATION_PROMPT_INTERVAL_MS) {
                    
                    if (nextTurnDistance > 300 && nextTurnDistance <= 400) {
                        warningText = `400 metre sonra ${direction} dönün.`;
                    } else if (nextTurnDistance > 100 && nextTurnDistance <= 150) {
                        warningText = `150 metre sonra ${direction} dönün.`;
                    } else if (nextTurnDistance > 40 && nextTurnDistance <= 70) {
                        warningText = `50 metre sonra ${direction} dönün.`;
                    } else if (nextTurnDistance <= 40) {
                        warningText = `Şimdi ${direction} dönün.`;
                    }
                    
                    if (warningText) {
                        speak(warningText);
                        guidanceMessage = warningText; 
                        lastNavigationPromptTime = currentTime;
                    }
                }
            }

            document.getElementById('guidance-text').textContent = guidanceMessage;
        }
        

        // Geolocation Başlangıç İşlemi
        function startGeolocation() {
            if (navigator.geolocation) {
                document.getElementById('status-text').textContent = 'Konum Alınıyor...';
                
                if (watchId === null) {
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude, heading } = position.coords;
                            
                            // 1. Kullanıcı Marker'ını ve Harita Pan'ı Güncelle
                            if (!userMarker) {
                                userMarker = L.marker([latitude, longitude], {
                                    icon: L.divIcon({ className: 'user-marker', html: '<div style="background-color:blue; width:15px; height:15px; border-radius:50%; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>', iconSize: [15, 15] })
                                }).addTo(map);
                            } else {
                                userMarker.setLatLng([latitude, longitude]);
                            }
                            
                            if (KML_ROUTE_COORDS.length === 0) {
                                map.panTo([latitude, longitude]);
                                document.getElementById('status-text').textContent = 'Konum Aktif';
                                document.getElementById('start-button').disabled = true;
                                return;
                            }
                            
                            // 2. Navigasyon Mantığını Çalıştır (KML yüklü ve konum aktifse)
                            guidanceLogic(latitude, longitude, heading);
                            
                        },
                        (error) => {
                            const errorMessage = error.message || 'Bilinmeyen bir hata oluştu.';
                            console.error('Konum hatası:', errorMessage, error);
                            
                            document.getElementById('status-text').textContent = `HATA: Konum Alınamıyor (${errorMessage})`;
                            document.getElementById('start-button').disabled = true; 
                            speak("Konumunuzu alırken bir hata oluştu.");
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                }
            } else {
                document.getElementById('status-text').textContent = 'HATA: Tarayıcı GPS desteklemiyor.';
                speak("Cihazınız konum takibini desteklemiyor.");
            }
        }

        /**
         * Rota takibini durdurur.
         * @param {boolean} saveLocation Durdurulan yeri kaydet ve devam etme moduna geç (rota tamamlanmadıysa true).
         */
        function stopTracking(saveLocation = true) {
            isTracking = false;
            isDrawingTrack = false; 

            // Eğer durdurulmuşsa, son konumu kaydet 
            if (saveLocation && userMarker) {
                 const currentLatLng = userMarker.getLatLng();
                 lastValidStopLocation = currentLatLng;
                 
                 // Kırmızı durma işaretçisini ekle
                 if (stopLocationMarker) { map.removeLayer(stopLocationMarker); }
                 stopLocationMarker = L.marker(lastValidStopLocation, { 
                    icon: L.divIcon({ className: 'stop-marker', html: '<div class="stop-marker-div"></div>', iconSize: [20, 20] })
                 }).addTo(map)
                   .bindPopup("<b>Durdurulan Konum (Devam Et)</b>");

            } else {
                // Tamamlandıysa veya KML kaldırıldıysa sıfırla
                lastValidStopLocation = null;
                if (stopLocationMarker) { map.removeLayer(stopLocationMarker); stopLocationMarker = null; }
            }

            // Buton metnini ve durumunu sıfırla
            document.getElementById('start-button').textContent = 'Rotayı Başlat';
            document.getElementById('start-button').disabled = true;
            document.getElementById('start-button').classList.remove('bg-red-600', 'bg-green-600');
            document.getElementById('start-button').classList.add('bg-blue-600');
            document.getElementById('status-text').textContent = 'Durduruldu';
            
            // Eğer rota tamamlanmadıysa, kullanıcıyı durdurulan yere yönlendir
            if (saveLocation && lastValidStopLocation) {
                 map.panTo(lastValidStopLocation);
            }
        }

        // Olay dinleyicisi
        document.getElementById('start-button').addEventListener('click', () => {
            if (KML_ROUTE_COORDS.length === 0 || !userMarker) {
                 speak("Lütfen önce K M L dosyasını yükleyin ve konumunuzun alınmasını bekleyin.");
                 return;
            }

            if (!isTracking) {
                // Başlatma veya Devam Etme Modu
                const userLatlng = userMarker.getLatLng();
                let isDevam = lastValidStopLocation != null;
                let targetLocation = isDevam ? lastValidStopLocation : L.latLng(KML_ROUTE_COORDS[0][0], KML_ROUTE_COORDS[0][1]);
                
                const distToTarget = haversineDistance(userLatlng.lat, userLatlng.lng, targetLocation.lat, targetLocation.lng);

                if (distToTarget <= RESUME_RADIUS_METERS) {
                    
                    // Durdurulan konumu ve işaretçiyi temizle (çünkü devam ediyor)
                    if (isDevam) {
                         if (stopLocationMarker) { map.removeLayer(stopLocationMarker); stopLocationMarker = null; }
                         lastValidStopLocation = null;
                         
                         // Devam ederken en yakın rotadan noktayı bul ve nearestPointIndex'i güncelle.
                         const { closestIndex } = getClosestDistanceToRoute(userLatlng.lat, userLatlng.lng);
                         if (closestIndex !== -1) {
                             nearestPointIndex = closestIndex;
                         }
                         
                    } else {
                         // Başlangıç modunda, en yakın indexi başlangıç noktası olarak ayarla
                         nearestPointIndex = 0;
                         currentRoutePolyline.setLatLngs([]); // Mavi çizgiyi temizle
                    }
                    
                    // Mavi rota çizimine BAŞLA/DEVAM ET
                    isDrawingTrack = true;
                    currentRoutePolyline.addLatLng(userMarker.getLatLng());
                    
                    // Takibi Aktif Et
                    isTracking = true;
                    lastStartPromptTime = 0;
                    lastNavigationPromptTime = 0;

                    document.getElementById('start-button').textContent = 'Takip Aktif (Durdur)';
                    document.getElementById('start-button').disabled = false;
                    document.getElementById('start-button').classList.remove('bg-green-600', 'bg-blue-600');
                    document.getElementById('start-button').classList.add('bg-red-600');
                    document.getElementById('status-text').textContent = 'Rota Takibi Aktif';
                    
                    const startMessage = isDevam
                        ? "Rotaya devam ediliyor. Lütfen siyah çizgiyi takip edin."
                        : "Rota takibi başlatıldı. Lütfen siyah çizgiyi takip edin.";
                    
                    document.getElementById('guidance-text').textContent = startMessage;
                    speak(startMessage);
                    
                } else {
                    speak("Başlatmak veya devam etmek için hedef noktaya yeterince yakın değilsiniz.");
                }
                
            } else {
                // Takibi Durdur
                stopTracking(true); // Durdurulan konumu kaydet
                document.getElementById('guidance-text').textContent = 'Navigasyon durduruldu. Durduğunuz yerden devam etmek için kırmızı noktaya yaklaşın.';
                speak("Rota takibi durduruldu. Durduğunuz yerden devam etmek için o noktaya yaklaşın.");
            }
        });
        
        // KML dosya seçimi dinleyicisi
        document.getElementById('kml-file').addEventListener('change', handleKmlUpload);


        // Uygulama Başlangıcı
        document.addEventListener('firebaseReady', () => {
            const userIdDisplay = document.getElementById('user-id-display');
            if (typeof window.userId === 'undefined') {
                userIdDisplay.textContent = 'Yerel Kullanıcı';
            } else {
                 userIdDisplay.textContent = window.userId;
            }
           
            setupMap();
            startGeolocation(); 
            document.getElementById('message-container').classList.remove('hidden'); 
        });

    </script>
</body>
</html>
